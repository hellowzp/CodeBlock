#include "heroreal.h"
#include "mainwindow.h"
#include <QDebug>
#include "gift.h"

HeroReal::HeroReal(int role, int id, int x, int y, int healthPercentage, int magicPercentage): Hero(role, id, x, y, healthPercentage, magicPercentage)
{

    this->_healthValue = healthPercentage * _totalHealth / 100;
    this->_magicValue = magicPercentage * _totalMagic / 100;

    QObject::connect(this, SIGNAL(needToMove()), this, SLOT(moveOneStep()));
}


void HeroReal::run(){

    while (true) {

        this->msleep(100 + 1000 / _speed);
        emit needToMove();
    }


}

void HeroReal::faceToDirection(int d) {

    this->_facingDir = d;

//    switch (_facingDir) {
//    case 1:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(270)));
//        break;
//    case 2:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(315)));
//        break;
//    case 3:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(0)));
//        break;
//    case 4:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(45)));;
//        break;
//    case 5:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(90)));
//        break;
//    case 6:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(135)));
//        break;
//    case 7:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(180)));
//        break;
//    case 8:
//        this->setPixmap(QPixmap(":/world/angry-bird-icon.png").transformed(QTransform().rotate(225)));
//        break;
//    default:
//        break;
//    }
}

void HeroReal::startMoving(){

    this->start();
}

void HeroReal::stopMoving(){

    this->terminate();

    emit heroMovingStoped(this->getId());  //to game client
    emit needToRepathOpponents(this->getId()); // to world view
}

void HeroReal::moveOneStep() {

    int nextX;
    int nextY;

    switch (_facingDir) {
    case 1:
        nextX = this->getXPos();
        nextY = this->getYPos() - 1;
        break;
    case 2:
        nextX = this->getXPos() + 1;
        nextY = this->getYPos() - 1;
        break;
    case 3:
        nextX = this->getXPos() + 1;
        nextY = this->getYPos();
        break;
    case 4:
        nextX = this->getXPos() + 1;
        nextY = this->getYPos() + 1;
        break;
    case 5:
        nextX = this->getXPos();
        nextY = this->getYPos() + 1;
        break;
    case 6:
        nextX = this->getXPos() - 1;
        nextY = this->getYPos() + 1;
        break;
    case 7:
        nextX = this->getXPos() - 1;
        nextY = this->getYPos();
        break;
    case 8:
        nextX = this->getXPos() - 1;
        nextY = this->getYPos() - 1;
        break;
    default:
        break;
    }

    this->setXPos(nextX);
    this->setYPos(nextY);
    this->setPos(this->getXPos() * SCALE_FACTOR, this->getYPos() * SCALE_FACTOR);

    emit heroMoved(this->getId(), this->getXPos(), this->getYPos()); // to game client
    emit needToRepathOpponents(this->getId());

    for (Gift *gift : this->_world->_gifts) {

        if (this->getXPos() == gift->getXPos()) {

            if (this->getYPos() == gift->getYPos()) {

                qDebug() << "Hero : steped on a gift " << gift->getXPos() << " " << gift->getYPos();
                emit giftPicked(this->getId(), gift->getId(), gift->getType());

                break;
            }
        }
    }
}

void HeroReal::injureHero(int value)
{
    _healthValue -= value;
    if (_healthValue <= 0) {

        _healthValue = 0;
    }

    int percentage = _healthValue * 100 / _totalHealth;
    this->setHealthPercentage(percentage);

    emit heroInjured(this->getId(), percentage);
}

void HeroReal::releaseMagicAt(int x, int y)
{
    if (!this->getMagic().isRunning()) {
        this->getMagic().releaseAt(x, y);
        emit magicReleased(this->getId(), x, y);
    }
}


int HeroReal::getHealthPercentage()
{
    return _healthValue * 100 / _totalHealth;
}

int HeroReal::getMagicPercentage() {

    return _magicValue * 100 / _totalMagic;
}
