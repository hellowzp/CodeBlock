#include "gameclient.h"
#include <QDebug>
#include <QDataStream>


GameClient* GameClient::_instance = 0;

GameClient::GameClient(Room room, Player player)
{
    this->_socket = new QTcpSocket();

    this->_room = room;
    this->_player = player;
    QObject::connect(_socket, SIGNAL(readyRead()), this, SLOT(readData()));
    this->_socket->connectToHost(_room.senderAddress, TCP_CONNECTION_PORT);
}



void GameClient::CreateClient(Room room, Player player)
{
    if (GameClient::_instance == nullptr) {
        GameClient::_instance = new GameClient(room, player);
    }
}

GameClient *GameClient::Instance()
{
    return GameClient::_instance;
}

void GameClient::setPlayer(Player player)
{
    this->_player = player;
}

Room GameClient::getRoom()
{
    return this->_room;
}

void GameClient::playerChanged(Player player)
{
    _player = player;

    //send the imformation of this player to server
    QByteArray data;
    QDataStream dataStream(&data, QIODevice::WriteOnly);
    int16_t type = TCP_DATA_TYPE_PLAYER;
    int16_t size = _player.getByteSize();
    dataStream << type << size << _player;
    this->_socket->write(data.data(), data.size());
    this->_socket->flush();
}

void GameClient::requestOtherPlayers()
{

    //request the information of all other player from the server
    QByteArray request;
    QDataStream requestStream(&request, QIODevice::WriteOnly);
    int16_t type1 = TCP_DATA_TYPE_QUERY_PLAYERS;
    int16_t size1= 0;
    requestStream << type1 << size1;
    this->_socket->write(request.data(), request.size());
    this->_socket->flush();

}

void GameClient::worldCreated()
{
    QByteArray created;
    QDataStream createdStream(&created, QIODevice::WriteOnly);
    int16_t type = TCP_DATA_TYPE_WORLD_CREATED;
    int16_t size = 0;
    createdStream << type << size;
    this->_socket->write(created.data(), created.size());
    this->_socket->flush();

}

void GameClient::heroCreated(HeroModel hero)
{

    QByteArray heroData;
    QDataStream heroStream(&heroData, QIODevice::WriteOnly);
    int16_t type = TCP_DATA_TYPE_NEW_HERO;
    int16_t size = hero.getByteSize();
    heroStream << type << size << hero;
    this->_socket->write(heroData.data(), heroData.size());
    this->_socket->flush();
}

void GameClient::heroMoved(int id, int x, int y)
{
    QByteArray moveData;
    QDataStream moveStream(&moveData, QIODevice::WriteOnly);
    int16_t type = TCP_DATA_TYPE_HERO_MOVE;
    int16_t size = sizeof(int16_t) * 3;
    moveStream << type << size << (int16_t)id << (int16_t)x << (int16_t)y;
    this->_socket->write(moveData.data(), moveData.size());
    this->_socket->flush();
}

void GameClient::readData()
{

    while (this->_socket->bytesAvailable() > 0) {

        QByteArray headerData;
        headerData.resize(sizeof(int16_t) * 2);
        this->_socket->read(headerData.data(), sizeof(int16_t) * 2);
        QDataStream headerDataStream(&headerData, QIODevice::ReadOnly);
        int16_t type;
        int16_t size;
        headerDataStream >> type;
        headerDataStream >> size;

        QByteArray data;
        data.resize(size);
        this->_socket->read(data.data(), size);
        QDataStream dataStream(&data, QIODevice::ReadOnly);

        if (type == TCP_DATA_TYPE_CON_ID) {


            dataStream >> _connectionId;
            qDebug() << "Client : The connection id is " << _connectionId;

            //set the player id of this player
            this->_player.id = _connectionId;

            //send the imformation of this player to server
            QByteArray data;
            QDataStream dataStream(&data, QIODevice::WriteOnly);
            int16_t type = TCP_DATA_TYPE_PLAYER;
            int16_t size = _player.getByteSize();
            dataStream << type << size << _player;
            this->_socket->write(data.data(), data.size());
            this->_socket->flush();

            //add my player into UI
            emit needSetMyPlayer(_player);

        } else if (type == TCP_DATA_TYPE_PLAYER) {


            Player player;
            dataStream >> player;

            if (player.id != _player.id) {
                emit needSetOtherPlayer(player);
                qDebug() << "Client other player received with name:" << player.playerName;
            }
        } else if (type == TCP_DATA_TYPE_NEED_CREATE_WORLD) {

            qDebug() << "Client: start game received";

            //emit the create signal to the main window
            emit needToCreateWorld(_room.map);

        } else if (type == TCP_DATA_TYPE_HERO_REQUEST) {

            qDebug() << "Client: hero request received";

            //emit the signal to world view
            int16_t x;
            int16_t y;
            dataStream >> x >> y;
            emit needToCreateHero(_player.role, _player.id, x, y);

        } else if (type == TCP_DATA_TYPE_NEW_HERO) {

            HeroModel hero;
            dataStream >> hero;

            this->_otherHeros.push_back(hero);
            emit needToAddHeroShadow(hero);
            qDebug() << "Client other hero received";

        } else if (type == TCP_DATA_TYPE_HERO_MOVE) {

            int16_t id;
            int16_t x;
            int16_t y;

            dataStream >> id >> x >> y;

            emit needToMoveShadow(id, x, y); // to world view

        }





    }


}


